#!/usr/bin/env bash
set -euo pipefail

PLUGIN_CONTEXT=${BUILDKITE_PLUGIN_ANNOTATE_GIT_DIFF_CONTEXT:-"git-diff"}
PLUGIN_FORMAT=${BUILDKITE_PLUGIN_ANNOTATE_GIT_DIFF_FORMAT:-"markdown"}
PLUGIN_COMPARE_BRANCH=${BUILDKITE_PLUGIN_ANNOTATE_GIT_DIFF_COMPARE_BRANCH:-"main"}
PLUGIN_INCLUDE_MERGE_BASE=${BUILDKITE_PLUGIN_ANNOTATE_GIT_DIFF_INCLUDE_MERGE_BASE:-"true"}

# Get current SHA
CURRENT_SHA=${BUILDKITE_COMMIT}

if [ -n "${BUILDKITE_PLUGIN_ANNOTATE_GIT_DIFF_COMPARE_BRANCH:-}" ]; then
    # If compare_branch is set, fetch and compare against it
    git fetch origin "${PLUGIN_COMPARE_BRANCH}"

    if [[ "${PLUGIN_INCLUDE_MERGE_BASE}" == "true" ]]; then
        # Find the merge-base (common ancestor) between current commit and target branch
        COMPARE_SHA=$(git merge-base "origin/${PLUGIN_COMPARE_BRANCH}" "${CURRENT_SHA}")
    else
        # Use the head of the target branch
        COMPARE_SHA=$(git rev-parse "origin/${PLUGIN_COMPARE_BRANCH}")
    fi
else
    # If no compare_branch is set, compare against previous commit
    COMPARE_SHA=$(git rev-parse "${CURRENT_SHA}^1")
fi

# Create temporary markdown file
TEMP_MD=$(mktemp)
trap 'rm -f "${TEMP_MD}"' EXIT

if [[ "${PLUGIN_FORMAT}" == "markdown" ]]; then
    # Add header
    if [ -n "${BUILDKITE_PLUGIN_ANNOTATE_GIT_DIFF_COMPARE_BRANCH:-}" ]; then
        HEADER="Comparing changes between ${COMPARE_SHA:0:8} on ${PLUGIN_COMPARE_BRANCH} to ${CURRENT_SHA:0:8} on ${BUILDKITE_BRANCH}\n"
    else
        HEADER="Comparing changes between ${COMPARE_SHA:0:8} to ${CURRENT_SHA:0:8}\n"
    fi

    echo -e "${HEADER}" >> "${TEMP_MD}"

    # Add diff with terminal colors
    {
        echo '```term'
        git diff --color=always "${COMPARE_SHA}" "${CURRENT_SHA}"
        echo '```'
    } >> "${TEMP_MD}"

    # Add summary
    {
        echo
        echo "**Summary:** $(git diff --numstat "${COMPARE_SHA}" "${CURRENT_SHA}" | awk '
            BEGIN { additions = 0; deletions = 0; files = 0 }
            {
                additions += $1;
                deletions += $2;
                files += 1
            }
            END {
                print files " files changed, " additions " insertions(+), " deletions " deletions(-)"
            }
        ')"
    } >> "${TEMP_MD}"
else
    # Raw diff format
    git diff --color=always "${COMPARE_SHA}" "${CURRENT_SHA}" > "${TEMP_MD}"
fi

buildkite-agent annotate "$(cat "${TEMP_MD}")" \
    --context "${PLUGIN_CONTEXT}" \
    --style "info" \
    --append
