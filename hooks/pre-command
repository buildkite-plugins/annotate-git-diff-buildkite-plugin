#!/usr/bin/env bats

load '/usr/local/lib/bats/load.bash'

# Mock git
function git() {
  case "${1}" in
    "fetch")
      echo "Fetching ${2}/${3}"
      ;;
    "merge-base")
      echo "merge-base-sha"
      ;;
    "rev-parse")
      echo "compare-sha"
      ;;
    "diff")
      if [[ "${1}" == "--numstat" ]]; then
        echo "1    2    file1.txt"
        echo "3    4    file2.txt"
      else
        echo "diff --git a/file.txt b/file.txt"
        echo "index 1234567..89abcdef 100644"
        echo "--- a/file.txt"
        echo "+++ b/file.txt"
        echo "-old line"
        echo "+new line"
      fi
      ;;
  esac
}

# Mock buildkite-agent
function buildkite-agent() {
  echo "Annotating build with diff"
}

@test "Creates annotation with default settings" {
  export BUILDKITE_COMMIT="current-sha"
  export BUILDKITE_BRANCH="feature-branch"

  run "$PWD/hooks/pre-command"

  assert_success
  assert_output --partial "Annotating build with diff"
}

@test "Respects custom branch comparison" {
  export BUILDKITE_COMMIT="current-sha"
  export BUILDKITE_BRANCH="feature-branch"
  export BUILDKITE_PLUGIN_GIT_DIFF_COMPARE_BRANCH="develop"

  run "$PWD/hooks/pre-command"

  assert_success
  assert_output --partial "Annotating build with diff"
}

@test "Works with merge-base disabled" {
  export BUILDKITE_COMMIT="current-sha"
  export BUILDKITE_BRANCH="feature-branch"
  export BUILDKITE_PLUGIN_GIT_DIFF_INCLUDE_MERGE_BASE="false"

  run "$PWD/hooks/pre-command"

  assert_success
  assert_output --partial "Annotating build with diff"
}
