#!/usr/bin/env bash
set -euo pipefail

PLUGIN_CONTEXT=${BUILDKITE_PLUGIN_GIT_DIFF_CONTEXT:-"git-diff"}
PLUGIN_FORMAT=${BUILDKITE_PLUGIN_GIT_DIFF_FORMAT:-"markdown"}
PLUGIN_COMPARE_BRANCH=${BUILDKITE_PLUGIN_GIT_DIFF_COMPARE_BRANCH:-"main"}
PLUGIN_INCLUDE_MERGE_BASE=${BUILDKITE_PLUGIN_GIT_DIFF_INCLUDE_MERGE_BASE:-"true"}

# Get current SHA
CURRENT_SHA=${BUILDKITE_COMMIT}

if [ -n "${BUILDKITE_PLUGIN_GIT_DIFF_COMPARE_BRANCH:-}" ]; then
    # If compare_branch is set, fetch and compare against it
    git fetch origin "${PLUGIN_COMPARE_BRANCH}"

    if [[ "${PLUGIN_INCLUDE_MERGE_BASE}" == "true" ]]; then
        # Find the merge-base (common ancestor) between current commit and target branch
        COMPARE_SHA=$(git merge-base "origin/${PLUGIN_COMPARE_BRANCH}" "${CURRENT_SHA}")
    else
        # Use the head of the target branch
        COMPARE_SHA=$(git rev-parse "origin/${PLUGIN_COMPARE_BRANCH}")
    fi
else
    # If no compare_branch is set, compare against previous commit
    COMPARE_SHA=$(git rev-parse "${CURRENT_SHA}^1")
fi

# Generate the diff
if [[ "${PLUGIN_FORMAT}" == "markdown" ]]; then
  # Create header with branch information
  if [ -n "${BUILDKITE_PLUGIN_GIT_DIFF_COMPARE_BRANCH:-}" ]; then
    HEADER="### Git Diff: '${BUILDKITE_BRANCH}' vs '${PLUGIN_COMPARE_BRANCH}'"
  else
    HEADER="### Git Diff: Previous commit"
  fi

  HEADER+="\nComparing changes between ${COMPARE_SHA:0:8} and ${CURRENT_SHA:0:8}"

  # Generate a more readable markdown-formatted diff
  DIFF_OUTPUT=$(git diff --color=never "${COMPARE_SHA}" "${CURRENT_SHA}" | while IFS= read -r line; do
    # Add syntax highlighting markers
    if [[ "${line}" =~ ^diff|^index|^@@|^\+\+\+|^\-\-\- ]]; then
      printf "%s\n" "${line}"
    elif [[ "${line}" =~ ^\+ ]]; then
      printf "üíö %s\n" "${line}"
    elif [[ "${line}" =~ ^\- ]]; then
      printf "‚ùå %s\n" "${line}"
    else
      printf "%s\n" "${line}"
    fi
  done)

  # Combine header, diff, and summary
  FULL_OUTPUT="${HEADER}\n\n\`\`\`diff\n${DIFF_OUTPUT}\`\`\`"

  # Add summary of changes
  STATS=$(git diff --numstat "${COMPARE_SHA}" "${CURRENT_SHA}" | awk '
    BEGIN { additions = 0; deletions = 0; files = 0 }
    {
      additions += $1;
      deletions += $2;
      files += 1
    }
    END {
      print files " files changed, " additions " insertions(+), " deletions " deletions(-)"
    }
  ')
  DIFF_OUTPUT="${DIFF_OUTPUT}\n\n**Summary:** ${STATS}"
else
  # Raw diff format
  DIFF_OUTPUT=$(git diff --color=never "${COMPARE_SHA}" "${CURRENT_SHA}")
fi

buildkite-agent annotate "${DIFF_OUTPUT}" \
  --context "${PLUGIN_CONTEXT}" \
  --style "info" \
  --append
